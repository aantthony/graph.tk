/**
 * Copyleft 2010-2011 Jay and Han (laughinghan@gmail.com)
 *   under the GNU Lesser General Public License
 *     http://www.gnu.org/licenses/lgpl.html
 * Project Website: http://mathquill.com
 */(function(){function g(){}function h(){}function i(a,b,c){this.init(a,[b],[c||(a&&a.length>1?a.slice(1):a)])}function j(){}function k(b,c,d){if(!arguments.length)return;var e=this;e.parent=b,e.prev=c||0,e.next=d||0,e.jQinit(e.fold(a(),function(a,b){return b.jQ.add(a)}))}function l(c,e,f,g){function n(){m=b;var a=i.selection?"$"+i.selection.latex()+"$":"";l.val(a);if(a)if(l[0].select)l[0].select();else if(document.selection){var c=l[0].createTextRange();c.expand("textedit"),c.select()}}function q(b){return i.seek(a(b.target),b.pageX,b.pageY),(i.prev!==o.prev||i.parent!==o.parent)&&i.selectFrom(o),!1}function r(a){return delete a.target,q(a)}function s(d){o=b,i.blink=p,i.selection||(g?i.show():j.detach()),c.unbind("mousemove",q),a(document).unbind("mousemove",r).unbind("mouseup",s)}function u(){l.focus()}function v(){var a=l.val();a.slice(0,1)==="$"&&a.slice(-1)==="$"?a=a.slice(1,-1):a="\\text{"+a+"}",i.writeLatex(a).show(),l.val("")}function y(){if(x)return;var a=l.val();if(a){l.val("");for(var c=0;c<a.length;c+=1)i.parent.textInput(a.charAt(c))}else(i.selection||m!==b)&&n()}var h=c.contents().detach();f||c.addClass("mathquill-rendered-math"),e.jQ=c.data(d,{block:e,revert:function(){c.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox").append(h)}});var i=e.cursor=new Y(e);e.renderLatex(h.text());var j=e.textarea=a('<span class="textarea"><textarea></textarea></span>'),l=j.children(),m;e.selectionChanged=function(){m===b&&(m=setTimeout(n))},c.bind("selectstart.mathquill",function(a){a.target!==l[0]&&a.preventDefault(),a.stopPropagation()});var o,p=i.blink;c.bind("mousedown.mathquill",function(b){i.blink=a.noop,i.seek(a(b.target),b.pageX,b.pageY),o=new k(i.parent,i.prev,i.next),g||c.prepend(j),c.mousemove(q),a(document).mousemove(r).mouseup(s),b.stopPropagation()});if(!g){c.bind("cut paste",!1).bind("copy",n).prepend('<span class="selectable">$'+e.latex()+"$</span>"),l.blur(function(){i.clearSelection(),setTimeout(t)});function t(){j.detach()}return}c.prepend(j),c.addClass("mathquill-editable"),f&&c.addClass("mathquill-textbox"),l.focus(function(a){i.parent||i.appendTo(e),i.parent.jQ.addClass("hasCursor"),i.selection?(i.selection.jQ.removeClass("blur"),setTimeout(e.selectionChanged)):i.show(),a.stopPropagation()}).blur(function(a){i.hide().parent.blur(),i.selection&&i.selection.jQ.addClass("blur"),a.stopPropagation()}),c.bind("focus.mathquill blur.mathquill",function(a){l.trigger(a)}).bind("mousedown.mathquill",function(){setTimeout(u)}).bind("click.mathquill",u).blur(),c.bind("cut",function(a){n(),i.selection&&setTimeout(function(){i.deleteSelection(),i.redraw()}),a.stopPropagation()}).bind("copy",function(a){n(),x=!0,a.stopPropagation()}).bind("paste",function(a){x=!0,setTimeout(v),a.stopPropagation()});var w={},x=!1;c.bind("keydown.mathquill",function(a){w.evt=a,w.happened=!0,i.parent.keydown(a)===!1&&a.preventDefault()}).bind("keypress.mathquill",function(a){w.happened?w.happened=!1:i.parent.keydown(w.evt),m!==b&&clearTimeout(m),(i.selection||m!==b)&&l.val(""),x=!1,setTimeout(y)})}function m(){}function n(a){this.init("$"),this.firstChild.cursor=a,this.firstChild.textInput=function(b){if(this.skipTextInput)return;b!=="$"||a.parent!==this?a.write(b):this.isEmpty()?a.insertAfter(this.parent).backspace().insertNew(new S("\\$","$")).show():a.next?a.prev?a.write(b):a.insertBefore(this.parent):a.insertAfter(this.parent)}}function o(){}function x(a,b){return b.prototype=a.prototype,b}function y(a){var b=Array.prototype.slice.call(arguments,1);return x(a,function(){a.apply(this,Array.prototype.concat.apply(b,arguments))})}function z(a,c,d){this.init(a,[c],b,d)}function A(a,b,c,d){this.init(a,[b],[c],d)}function B(a){this.init("\\frac",b,b,a),this.jQ.append('<span style="display:inline-block;width:0">&nbsp;</span>')}function C(){B.apply(this,arguments)}function D(a){this.init("\\sqrt",b,b,a)}function E(a){D.call(this,a),this.jQ=this.firstChild.jQ.detach().add(this.jQ)}function F(a,b,c,d,e){this.init("\\left"+c,['<span class="block"><span class="paren">'+a+'</span><span class="block"></span><span class="paren">'+b+"</span></span>"],[a,b],e),this.end="\\right"+d}function G(a,b,c,d,e){F.apply(this,arguments)}function H(a,b,c){F.call(this,a,b,a,b,c)}function I(a,b,c){G.call(this,a,b,a,b,c)}function J(a){H.call(this,"|","|",a)}function K(a){a instanceof k?this.replacedText=a.remove().jQ.text():typeof a=="string"&&(this.replacedText=a),this.init()}function L(){}function M(a,b){function d(){K.apply(this,arguments)}return c=d.prototype=new K,c.cmd=a,c.html_template=[b],d}function N(a){this.init("\\"),a&&(this.replacedFragment=a.detach(),this.isEmpty=function(){return!1})}function O(c){this.init("\\binom",b,b,c),this.jQ.wrapInner('<span class="array"></span>'),this.blockjQ=this.jQ.children(),this.bracketjQs=a('<span class="paren">(</span>').prependTo(this.jQ).add(a('<span class="paren">)</span>').appendTo(this.jQ))}function P(){O.apply(this,arguments)}function Q(a){this.init("\\vector",b,b,a)}function R(a,b){i.call(this,a,"<var>"+(b||a)+"</var>")}function S(a,b){i.call(this,a,"<span>"+(b||a)+"</span>")}function T(a,b){i.call(this,a,'<span class="nonSymbola">'+(b||a)+"</span>")}function U(a,b,c){i.call(this,a,'<span class="binary-operator">'+b+"</span>",c)}function V(a,b){S.apply(this,arguments)}function W(a,b){i.call(this,a,"<big>"+b+"</big>")}function X(a,b){i.call(this,"\\"+b+" ","<span>"+b+"</span>")}function Y(b){this.parent=this.root=b;var c=this.jQ=this._jQ=a('<span class="cursor"></span>');this.blink=function(){c.toggleClass("blink")}}function Z(a,b,c){k.apply(this,arguments)}var a=jQuery,b,c,d="[[mathquill internal data]]",e=Math.min,f=Math.max;c=g.prototype,c.prev=0,c.next=0,c.parent=0,c.firstChild=0,c.lastChild=0,c.eachChild=function(a){for(var b=this.firstChild;b;b=b.next)if(a.call(this,b)===!1)break;return this},c.foldChildren=function(a,b){return this.eachChild(function(c){a=b.call(this,a,c)}),a},c.keydown=function(a){return this.parent.keydown(a)},c.textInput=function(a){return this.parent.textInput(a)},c=h.prototype=new g,c.init=function(b,c,e,f){var g=this;b&&(g.cmd=b),c&&(g.html_template=c),e&&(g.text_template=e),g.jQ=a(g.html_template[0]).data(d,{cmd:g}),g.initBlocks(f)},c.initBlocks=function(b){var c=this;if(c.html_template.length===1){c.firstChild=c.lastChild=c.jQ.data(d).block=b&&b.blockify()||new j,c.firstChild.parent=c,c.firstChild.jQ=c.jQ.append(c.firstChild.jQ);return}var e,f,g=c.html_template.length;this.firstChild=e=f=b&&b.blockify()||new j,e.parent=c,e.jQ=a(c.html_template[1]).data(d,{block:e}).append(e.jQ).appendTo(c.jQ),e.blur();for(var h=2;h<g;h+=1)e=new j,e.parent=c,e.prev=f,f.next=e,f=e,e.jQ=a(c.html_template[h]).data(d,{block:e}).appendTo(c.jQ),e.blur();c.lastChild=e},c.latex=function(){return this.foldChildren(this.cmd,function(a,b){return a+"{"+(b.latex()||" ")+"}"})},c.text_template=[""],c.text=function(){var a=0;return this.foldChildren(this.text_template[a],function(b,c){a+=1;var d=c.text();return b&&this.text_template[a]==="("&&d[0]==="("&&d.slice(-1)===")"?b+d.slice(1,-1)+this.text_template[a]:b+c.text()+(this.text_template[a]||"")})},c.insertAt=function(a){var b=this;b.parent=a.parent,b.next=a.next,b.prev=a.prev,a.prev?a.prev.next=b:a.parent.firstChild=b,a.next?a.next.prev=b:a.parent.lastChild=b,a.prev=b,b.jQ.insertBefore(a.jQ),b.respace(),b.next&&b.next.respace(),b.prev&&b.prev.respace(),b.placeCursor(a),a.redraw()},c.respace=a.noop,c.placeCursor=function(a){a.appendTo(this.foldChildren(this.firstChild,function(a,b){return a.isEmpty()?a:b}))},c.isEmpty=function(){return this.foldChildren(!0,function(a,b){return a&&b.isEmpty()})},c.remove=function(){var a=this,b=a.prev,c=a.next,d=a.parent;return b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,a.jQ.remove(),a},c=i.prototype=new h,c.initBlocks=a.noop,c.latex=function(){return this.cmd},c.text=function(){return this.text_template},c.placeCursor=a.noop,c.isEmpty=function(){return!0},c=j.prototype=new g,c.latex=function(){return this.foldChildren("",function(a,b){return a+b.latex()})},c.text=function(){return this.firstChild===this.lastChild?this.firstChild.text():this.foldChildren("(",function(a,b){return a+b.text()})+")"},c.isEmpty=function(){return this.firstChild===0&&this.lastChild===0},c.focus=function(){return this.jQ.addClass("hasCursor"),this.isEmpty()&&this.jQ.removeClass("empty"),this},c.blur=function(){return this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty"),this},c=k.prototype,c.remove=h.prototype.remove,c.jQinit=function(a){this.jQ=a},c.each=function(a){for(var b=this.prev.next||this.parent.firstChild;b!==this.next;b=b.next)if(a.call(this,b)===!1)break;return this},c.fold=function(a,b){return this.each(function(c){a=b.call(this,a,c)}),a},c.latex=function(){return this.fold("",function(a,b){return a+b.latex()})},c.blockify=function(){var a=this,b=a.prev,c=a.next,d=a.parent,e=new j,f=e.firstChild=b.next||d.firstChild,g=e.lastChild=c.prev||d.lastChild;return b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,f.prev=a.prev=0,g.next=a.next=0,a.parent=e,a.each(function(a){a.parent=e}),e.jQ=a.jQ,e},c=m.prototype=new j,c.latex=function(){return j.prototype.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")},c.text=function(){return this.foldChildren("",function(a,b){return a+b.text()})},c.renderLatex=function(a){this.jQ.children().slice(1).remove(),this.firstChild=this.lastChild=0,this.cursor.appendTo(this).writeLatex(a),this.blur()},c.keydown=function(a){a.ctrlKey=a.ctrlKey||a.metaKey;switch(a.originalEvent&&a.originalEvent.keyIdentifier||a.which){case 8:case"Backspace":case"U+0008":if(a.ctrlKey)while(this.cursor.prev||this.cursor.selection)this.cursor.backspace();else this.cursor.backspace();break;case 27:case"Esc":case"U+001B":case 9:case"Tab":case"U+0009":if(a.ctrlKey)break;var b=this.cursor.parent;if(a.shiftKey){if(b===this.cursor.root)return this.skipTextInput=!0;b.prev?this.cursor.appendTo(b.prev):this.cursor.insertBefore(b.parent)}else{if(b===this.cursor.root)return this.skipTextInput=!0;b.next?this.cursor.prependTo(b.next):this.cursor.insertAfter(b.parent)}this.cursor.clearSelection();break;case 13:case"Enter":break;case 35:case"End":if(a.shiftKey)while(this.cursor.next||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectRight();else this.cursor.clearSelection().appendTo(a.ctrlKey?this:this.cursor.parent);break;case 36:case"Home":if(a.shiftKey)while(this.cursor.prev||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectLeft();else this.cursor.clearSelection().prependTo(a.ctrlKey?this:this.cursor.parent);break;case 37:case"Left":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectLeft():this.cursor.moveLeft();break;case 38:case"Up":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.prev)while(this.cursor.prev)this.cursor.selectLeft();else this.cursor.selectLeft();else this.cursor.parent.prev?this.cursor.clearSelection().appendTo(this.cursor.parent.prev):this.cursor.prev?this.cursor.clearSelection().prependTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertBefore(this.cursor.parent.parent);break;case 39:case"Right":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectRight():this.cursor.moveRight();break;case 40:case"Down":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.next)while(this.cursor.next)this.cursor.selectRight();else this.cursor.selectRight();else this.cursor.parent.next?this.cursor.clearSelection().prependTo(this.cursor.parent.next):this.cursor.next?this.cursor.clearSelection().appendTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertAfter(this.cursor.parent.parent);break;case 46:case"Del":case"U+007F":if(a.ctrlKey)while(this.cursor.next||this.cursor.selection)this.cursor.deleteForward();else this.cursor.deleteForward();break;case 65:case"A":case"U+0041":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);this.cursor.clearSelection().appendTo(this);while(this.cursor.prev)this.cursor.selectLeft();break};default:return this.skipTextInput=!1,!0}return this.skipTextInput=!0,!1},c.textInput=function(a){this.skipTextInput||this.cursor.write(a)},c=n.prototype=new h,c.html_template=['<span class="mathquill-rendered-math"></span>'],c.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(d).block=new m,this.firstChild.parent=this,this.firstChild.jQ=this.jQ},c.latex=function(){return"$"+this.firstChild.latex()+"$"},c=o.prototype=new j,c.renderLatex=function(a){var b=this,c=b.cursor;b.jQ.children().slice(1).remove(),b.firstChild=b.lastChild=0,c.show().appendTo(b),a=a.match(/(?:\\\$|[^$])+|\$(?:\\\$|[^$])*\$|\$(?:\\\$|[^$])*$/g)||"";for(var d=0;d<a.length;d+=1){var e=a[d];if(e[0]==="$"){e[-1+e.length]==="$"&&e[-2+e.length]!=="\\"?e=e.slice(1,-1):e=e.slice(1);var f=new n(c);c.insertNew(f),f.firstChild.renderLatex(e),c.show().insertAfter(f)}else for(var g=0;g<e.length;g+=1)this.cursor.insertNew(new S(e[g]))}},c.keydown=m.prototype.keydown,c.textInput=function(a){if(this.skipTextInput)return;this.cursor.deleteSelection(),a==="$"?this.cursor.insertNew(new n(this.cursor)):this.cursor.insertNew(new S(a))};var p={},q={},r,s=document.createElement("div"),t=s.style,u={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1},v;for(var w in u)if(w in t){v=w;break}v?r=function(a,b,c){a.css(v,"scale("+b+","+c+")")}:"filter"in t?r=function(a,b,c){a.css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+b+",M22="+c+",SizingMethod='auto expand')")}:r=function(a,b,c){a.css("fontSize",c+"em")},x(h,z),q.mathrm=y(z,"\\mathrm",'<span class="roman font"></span>'),q.mathit=y(z,"\\mathit",'<i class="font"></i>'),q.mathbf=y(z,"\\mathbf",'<b class="font"></b>'),q.mathsf=y(z,"\\mathsf",'<span class="sans-serif font"></span>'),q.mathtt=y(z,"\\mathtt",'<span class="monospace font"></span>'),q.underline=y(z,"\\underline",'<span class="underline"></span>'),q.overline=q.bar=y(z,"\\overline",'<span class="overline"></span>'),c=A.prototype=new h,c.latex=function(){var a=this.firstChild.latex();return a.length===1?this.cmd+a:this.cmd+"{"+(a||" ")+"}"},c.redraw=function(){this.respace(),this.next&&this.next.respace(),this.prev&&this.prev.respace()},c.respace=function(){this.prev.cmd==="\\int "||this.prev instanceof A&&this.prev.cmd!=this.cmd&&this.prev.prev&&this.prev.prev.cmd==="\\int "?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit"));if(this.respaced=this.prev instanceof A&&this.prev.cmd!=this.cmd&&!this.prev.respaced){var a=+this.jQ.css("fontSize").slice(0,-2),b=this.prev.jQ.outerWidth();thisWidth=this.jQ.outerWidth(),this.jQ.css({left:(this.limit&&this.cmd==="_"?-0.25:0)-b/a+"em",marginRight:.1-e(thisWidth,b)/a+"em"})}else this.limit&&this.cmd==="_"?this.jQ.css({left:"-.25em",marginRight:""}):this.jQ.css({left:"",marginRight:""});return this},q.subscript=q._=x(A,function(a){A.call(this,"_","<sub></sub>","_",a)}),q.superscript=q.supscript=q["^"]=x(A,function(a){A.call(this,"^","<sup></sup>","**",a)}),c=B.prototype=new h,c.html_template=['<span class="fraction"></span>','<span class="numerator"></span>','<span class="denominator"></span>'],c.text_template=["(","/",")"],q.frac=q.dfrac=q.cfrac=q.fraction=B,c=C.prototype=new B,c.placeCursor=function(a){if(this.firstChild.isEmpty()){var b=this.prev;while(b&&!(b instanceof U||b instanceof K||b instanceof W))b=b.prev;b instanceof W&&b.next instanceof A&&(b=b.next,b.next instanceof A&&b.next.cmd!=b.cmd&&(b=b.next));if(b!==this.prev){var c=(new k(this.parent,b,this)).blockify();c.jQ=this.firstChild.jQ.empty().removeClass("empty").append(c.jQ).data(d,{block:c}),c.next=this.lastChild,c.parent=this,this.firstChild=this.lastChild.prev=c}}a.appendTo(this.lastChild)},q.over=p["/"]=C,c=D.prototype=new h,c.html_template=['<span class="block"><span class="sqrt-prefix">&radic;</span></span>','<span class="sqrt-stem"></span>'],c.text_template=["sqrt(",")"],c.redraw=function(){var a=this.lastChild.jQ;r(a.prev(),1,a.innerHeight()/+a.css("fontSize").slice(0,-2)-.1)},q.sqrt=q["√"]=D,c=E.prototype=new D,c.html_template=['<span class="block"><span class="sqrt-prefix">&radic;</span></span>','<sup class="nthroot"></sup>','<span class="sqrt-stem"></span>'],c.text_template=["sqrt[","](",")"],c.latex=function(){return"\\sqrt["+this.firstChild.latex()+"]{"+this.lastChild.latex()+"}"},q.nthroot=E,c=F.prototype=new h,c.initBlocks=function(a){this.firstChild=this.lastChild=a&&a.blockify()||new j,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.children(":eq(1)").data(d,{block:this.firstChild}).append(this.firstChild.jQ);var b=this.blockjQ=this.firstChild.jQ;this.bracketjQs=b.prev().add(b.next())},c.latex=function(){return this.cmd+this.firstChild.latex()+this.end},c.redraw=function(){var a=this.blockjQ.outerHeight()/+this.blockjQ.css("fontSize").slice(0,-2);r(this.bracketjQs,e(1+.2*(a-1),1.2),1.05*a)},q.lbrace=p["{"]=x(F,function(a){F.call(this,"{","}","\\{","\\}",a)}),q.langle=q.lang=x(F,function(a){F.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),c=G.prototype=new F,c.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):this.firstChild.blur()},q.rbrace=p["}"]=x(G,function(a){G.call(this,"{","}","\\{","\\}",a)}),q.rangle=q.rang=x(G,function(a){G.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),H.prototype=F.prototype,q.lparen=p["("]=x(H,function(a){H.call(this,"(",")",a)}),q.lbrack=q.lbracket=p["["]=x(H,function(a){H.call(this,"[","]",a)}),I.prototype=G.prototype,q.rparen=p[")"]=x(I,function(a){I.call(this,"(",")",a)}),q.rbrack=q.rbracket=p["]"]=x(I,function(a){I.call(this,"[","]",a)}),c=J.prototype=new H,c.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):a.appendTo(this.firstChild)},q.lpipe=q.rpipe=p["|"]=J,c=K.prototype=new h,c.cmd="\\text",c.html_template=['<span class="text"></span>'],c.text_template=['"','"'],c.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(d).block=new L,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.append(this.firstChild.jQ)},c.placeCursor=function(a){(this.cursor=a).appendTo(this.firstChild);if(this.replacedText)for(var b=0;b<this.replacedText.length;b+=1)this.write(this.replacedText.charAt(b))},c.write=function(a){this.cursor.insertNew(new S(a))},c.keydown=function(a){return!this.cursor.selection&&(a.which===8&&!this.cursor.prev||a.which===46&&!this.cursor.next)?(this.isEmpty()&&this.cursor.insertAfter(this),!1):this.parent.keydown(a)},c.textInput=function(a){this.cursor.deleteSelection();if(a!=="$")this.write(a);else if(this.isEmpty())this.cursor.insertAfter(this).backspace().insertNew(new S("\\$","$"));else if(!this.cursor.next)this.cursor.insertAfter(this);else if(!this.cursor.prev)this.cursor.insertBefore(this);else{var b=new K(new k(this.firstChild,this.cursor.prev));b.placeCursor=function(a){this.prev=0,delete this.placeCursor,this.placeCursor(a)},b.firstChild.focus=function(){return this},this.cursor.insertAfter(this).insertNew(b),b.prev=this,this.cursor.insertBefore(b),delete b.firstChild.focus}},c=L.prototype=new j,c.blur=function(){this.jQ.removeClass("hasCursor");if(this.isEmpty()){var a=this.parent,b=a.cursor;b.parent===this?this.jQ.addClass("empty"):(b.hide(),a.remove(),b.next===a?b.next=a.next:b.prev===a&&(b.prev=a.prev),b.show().redraw())}return this},c.focus=function(){j.prototype.focus.call(this);var a=this.parent;if(a.next.cmd===a.cmd){var b=this,c=a.cursor,d=a.next.firstChild;d.eachChild(function(a){a.parent=b,a.jQ.appendTo(b.jQ)}),this.lastChild?this.lastChild.next=d.firstChild:this.firstChild=d.firstChild,d.firstChild.prev=this.lastChild,this.lastChild=d.lastChild,d.parent.remove(),c.prev?c.insertAfter(c.prev):c.prependTo(this),c.redraw()}else if(a.prev.cmd===a.cmd){var c=a.cursor;c.prev?a.prev.firstChild.focus():c.appendTo(a.prev.firstChild)}return this},p.$=q.text=q.textnormal=q.textrm=q.textup=q.textmd=K,q.em=q.italic=q.italics=q.emph=q.textit=q.textsl=M("\\textit",'<i class="text"></i>'),q.strong=q.bold=q.textbf=M("\\textbf",'<b class="text"></b>'),q.sf=q.textsf=M("\\textsf",'<span class="sans-serif text"></span>'),q.tt=q.texttt=M("\\texttt",'<span class="monospace text"></span>'),q.textsc=M("\\textsc",'<span style="font-variant:small-caps" class="text"></span>'),q.uppercase=M("\\uppercase",'<span style="text-transform:uppercase" class="text"></span>'),q.lowercase=M("\\lowercase",'<span style="text-transform:lowercase" class="text"></span>'),c=N.prototype=new h,c.html_template=['<span class="latex-command-input">\\</span>'],c.text_template=["\\"],c.placeCursor=function(b){this.cursor=b.appendTo(this.firstChild),this.replacedFragment&&(this.jQ=this.jQ.add(this.replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(b){return a(b.target=this.nextSibling).trigger(b),!1}).insertBefore(this.jQ)))},c.latex=function(){return"\\"+this.firstChild.latex()+" "},c.keydown=function(a){return a.which===9||a.which===13?(this.renderCommand(),!1):this.parent.keydown(a)},c.textInput=function(a){if(a.match(/[a-z]/i)){this.cursor.deleteSelection(),this.cursor.insertNew(new S(a));return}this.renderCommand();if(a===" "||a==="\\"&&this.firstChild.isEmpty())return;this.cursor.parent.textInput(a)},c.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this.next?this.cursor.insertBefore(this.next):this.cursor.appendTo(this.parent);var a=this.firstChild.latex(),b;if(a)if(b=q[a])b=new b(this.replacedFragment,a);else{b=new K(a),b.firstChild.focus=function(){return delete this.focus,this},this.cursor.insertNew(b).insertAfter(b),this.replacedFragment&&this.replacedFragment.remove();return}else b=new S("\\backslash ","\\");this.cursor.insertNew(b),b instanceof i&&this.replacedFragment&&this.replacedFragment.remove()},p["\\"]=N,c=O.prototype=new h,c.html_template=['<span class="block"></span>',"<span></span>","<span></span>"],c.text_template=["choose(",",",")"],c.redraw=F.prototype.redraw,q.binom=q.binomial=O,c=P.prototype=new O,c.placeCursor=C.prototype.placeCursor,q.choose=P,c=Q.prototype=new h,c.html_template=['<span class="array"></span>',"<span></span>"],c.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(a,b){return a.push(b.latex()),a}).join("\\\\")+"\\end{matrix}"},c.text=function(){return"["+this.foldChildren([],function(a,b){return a.push(b.text()),a}).join()+"]"},c.placeCursor=function(a){this.cursor=a.appendTo(this.firstChild)},c.keydown=function(b){var c=this.cursor.parent;if(c.parent===this){if(b.which===13){var e=new j;return e.parent=this,e.jQ=a("<span></span>").data(d,{block:e}).insertAfter(c.jQ),c.next?c.next.prev=e:this.lastChild=e,e.next=c.next,c.next=e,e.prev=c,this.cursor.appendTo(e).redraw(),!1}if(b.which===9&&!b.shiftKey&&!c.next){if(c.isEmpty())return c.prev?(this.cursor.insertAfter(this),delete c.prev.next,this.lastChild=c.prev,c.jQ.remove(),this.cursor.redraw(),!1):this.parent.keydown(b);var e=new j;return e.parent=this,e.jQ=a("<span></span>").data(d,{block:e}).appendTo(this.jQ),this.lastChild=e,c.next=e,e.prev=c,this.cursor.appendTo(e).redraw(),!1}if(b.which===8){if(c.isEmpty())return c.prev?(this.cursor.appendTo(c.prev),c.prev.next=c.next):(this.cursor.insertBefore(this),this.firstChild=c.next),c.next?c.next.prev=c.prev:this.lastChild=c.prev,c.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.cursor.redraw(),!1;if(!this.cursor.prev)return!1}}return this.parent.keydown(b)},q.vector=Q,q.editable=x(n,function(){this.init("\\editable"),l(this.jQ,this.firstChild,!1,!0);var a;this.placeCursor=function(b){a=b.appendTo(this.firstChild)},this.firstChild.blur=function(){if(a.prev!==this.parent)return;delete this.blur,this.cursor.appendTo(this),j.prototype.blur.call(this)},this.latex=function(){return this.firstChild.latex()},this.text=function(){return this.firstChild.text()}}),q.f=y(i,"f",'<var class="florin">&fnof;</var>'),c=R.prototype=new i,c.text=function(){var a=this.cmd;return this.prev&&!(this.prev instanceof R)&&!(this.prev instanceof U)&&(a="*"+a),this.next&&!(this.next instanceof U)&&this.next.cmd!=="^"&&(a+="*"),a},S.prototype=i.prototype,p[" "]=y(S,"\\:"," "),q.prime=p["'"]=y(S,"'","&prime;"),T.prototype=i.prototype,q["@"]=T,q["&"]=y(T,"\\&","&"),q["%"]=y(T,"\\%","%"),q.alpha=q.beta=q.gamma=q.delta=q.zeta=q.eta=q.theta=q.iota=q.kappa=q.mu=q.nu=q.xi=q.rho=q.sigma=q.tau=q.chi=q.psi=q.omega=x(i,function(a,b){R.call(this,"\\"+b+" ","&"+b+";")}),q.phi=y(R,"\\phi ","&#981;"),q.phiv=q.varphi=y(R,"\\varphi ","&phi;"),q.epsilon=y(R,"\\epsilon ","&#1013;"),q.epsiv=q.varepsilon=y(R,"\\varepsilon ","&epsilon;"),q.piv=q.varpi=y(R,"\\varpi ","&piv;"),q.sigmaf=q.sigmav=q.varsigma=y(R,"\\varsigma ","&sigmaf;"),q.thetav=q.vartheta=q.thetasym=y(R,"\\vartheta ","&thetasym;"),q.upsilon=q.upsi=y(R,"\\upsilon ","&upsilon;"),q.gammad=q.Gammad=q.digamma=y(R,"\\digamma ","&#989;"),q.kappav=q.varkappa=y(R,"\\varkappa ","&#1008;"),q.rhov=q.varrho=y(R,"\\varrho ","&#1009;"),q.pi=q["π"]=y(T,"\\pi ","&pi;"),q.lambda=y(T,"\\lambda ","&lambda;"),q.Upsilon=q.Upsi=q.upsih=q.Upsih=y(i,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),q.Gamma=q.Delta=q.Theta=q.Lambda=q.Xi=q.Pi=q.Sigma=q.Phi=q.Psi=q.Omega=q.forall=x(i,function(a,b){S.call(this,"\\"+b+" ","&"+b+";")}),U.prototype=new i,c=V.prototype=new U,c.respace=function(){return this.prev?this.prev instanceof U&&this.next&&!(this.next instanceof U)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="",this},q["+"]=y(V,"+"),q["-"]=y(V,"-","&minus;"),q.pm=q.plusmn=q.plusminus=y(V,"\\pm ","&plusmn;"),q.mp=q.mnplus=q.minusplus=y(V,"\\mp ","&#8723;"),p["*"]=q.sdot=q.cdot=y(U,"\\cdot ","&middot;"),q["="]=y(U,"=","="),q["<"]=y(U,"<","&lt;"),q[">"]=y(U,">","&gt;"),q.notin=q.sim=q.cong=q.equiv=q.oplus=q.otimes=x(U,function(a,b){U.call(this,"\\"+b+" ","&"+b+";")}),q.times=x(U,function(a,b){U.call(this,"\\times ","&times;","[x]")}),q.div=q.divide=q.divides=y(U,"\\div ","&divide;","[/]"),q.ne=q.neq=y(U,"\\ne ","&ne;"),q.ast=q.star=q.loast=q.lowast=y(U,"\\ast ","&lowast;"),q.therefor=q.therefore=y(U,"\\therefore ","&there4;"),q.cuz=q.because=y(U,"\\because ","&#8757;"),q.prop=q.propto=y(U,"\\propto ","&prop;"),q.asymp=q.approx=y(U,"\\approx ","&asymp;"),q.lt=y(U,"<","&lt;"),q.gt=y(U,">","&gt;"),q.le=q.leq=y(U,"\\le ","&le;"),q.ge=q.geq=y(U,"\\ge ","&ge;"),q.isin=q["in"]=y(U,"\\in ","&isin;"),q.ni=q.contains=y(U,"\\ni ","&ni;"),q.notni=q.niton=q.notcontains=q.doesnotcontain=y(U,"\\not\\ni ","&#8716;"),q.sub=q.subset=y(U,"\\subset ","&sub;"),q.sup=q.supset=q.superset=y(U,"\\supset ","&sup;"),q.nsub=q.notsub=q.nsubset=q.notsubset=y(U,"\\not\\subset ","&#8836;"),q.nsup=q.notsup=q.nsupset=q.notsupset=q.nsuperset=q.notsuperset=y(U,"\\not\\supset ","&#8837;"),q.sube=q.subeq=q.subsete=q.subseteq=y(U,"\\subseteq ","&sube;"),q.supe=q.supeq=q.supsete=q.supseteq=q.supersete=q.superseteq=y(U,"\\supseteq ","&supe;"),q.nsube=q.nsubeq=q.notsube=q.notsubeq=q.nsubsete=q.nsubseteq=q.notsubsete=q.notsubseteq=y(U,"\\not\\subseteq ","&#8840;"),q.nsupe=q.nsupeq=q.notsupe=q.notsupeq=q.nsupsete=q.nsupseteq=q.notsupsete=q.notsupseteq=q.nsupersete=q.nsuperseteq=q.notsupersete=q.notsuperseteq=y(U,"\\not\\supseteq ","&#8841;"),W.prototype=new i,q.sum=q.summation=y(W,"\\sum ","&sum;"),q.prod=q.product=y(W,"\\prod ","&prod;"),q.coprod=q.coproduct=y(W,"\\coprod ","&#8720;"),q.int=q.integral=q["∫"]=y(W,"\\int ","&int;"),q.N=q.naturals=q.Naturals=y(S,"\\mathbb{N}","&#8469;"),q.P=q.primes=q.Primes=q.projective=q.Projective=q.probability=q.Probability=y(S,"\\mathbb{P}","&#8473;"),q.Z=q.integers=q.Integers=y(S,"\\mathbb{Z}","&#8484;"),q.Q=q.rationals=q.Rationals=y(S,"\\mathbb{Q}","&#8474;"),q.R=q.reals=q.Reals=y(S,"\\mathbb{R}","&#8477;"),q.C=q.complex=q.Complex=q.complexes=q.Complexes=q.complexplane=q.Complexplane=q.ComplexPlane=y(S,"\\mathbb{C}","&#8450;"),q.H=q.Hamiltonian=q.quaternions=q.Quaternions=y(S,"\\mathbb{H}","&#8461;"),q.quad=q.emsp=y(S,"\\quad ","    "),q.qquad=y(S,"\\qquad ","        "),q.diamond=y(S,"\\diamond ","&#9671;"),q.bigtriangleup=y(S,"\\bigtriangleup ","&#9651;"),q.ominus=y(S,"\\ominus ","&#8854;"),q.uplus=y(S,"\\uplus ","&#8846;"),q.bigtriangledown=y(S,"\\bigtriangledown ","&#9661;"),q.sqcap=y(S,"\\sqcap ","&#8851;"),q.triangleleft=y(S,"\\triangleleft ","&#8882;"),q.sqcup=y(S,"\\sqcup ","&#8852;"),q.triangleright=y(S,"\\triangleright ","&#8883;"),q.odot=y(S,"\\odot ","&#8857;"),q.bigcirc=y(S,"\\bigcirc ","&#9711;"),q.dagger=y(S,"\\dagger ","&#0134;"),q.ddagger=y(S,"\\ddagger ","&#135;"),q.wr=y(S,"\\wr ","&#8768;"),q.amalg=y(S,"\\amalg ","&#8720;"),q.models=y(S,"\\models ","&#8872;"),q.prec=y(S,"\\prec ","&#8826;"),q.succ=y(S,"\\succ ","&#8827;"),q.preceq=y(S,"\\preceq ","&#8828;"),q.succeq=y(S,"\\succeq ","&#8829;"),q.simeq=y(S,"\\simeq ","&#8771;"),q.mid=y(S,"\\mid ","&#8739;"),q.ll=y(S,"\\ll ","&#8810;"),q.gg=y(S,"\\gg ","&#8811;"),q.parallel=y(S,"\\parallel ","&#8741;"),q.bowtie=y(S,"\\bowtie ","&#8904;"),q.sqsubset=y(S,"\\sqsubset ","&#8847;"),q.sqsupset=y(S,"\\sqsupset ","&#8848;"),q.smile=y(S,"\\smile ","&#8995;"),q.sqsubseteq=y(S,"\\sqsubseteq ","&#8849;"),q.sqsupseteq=y(S,"\\sqsupseteq ","&#8850;"),q.doteq=y(S,"\\doteq ","&#8784;"),q.frown=y(S,"\\frown ","&#8994;"),q.vdash=y(S,"\\vdash ","&#8870;"),q.dashv=y(S,"\\dashv ","&#8867;"),q.longleftarrow=y(S,"\\longleftarrow ","&#8592;"),q.longrightarrow=y(S,"\\longrightarrow ","&#8594;"),q.Longleftarrow=y(S,"\\Longleftarrow ","&#8656;"),q.Longrightarrow=y(S,"\\Longrightarrow ","&#8658;"),q.longleftrightarrow=y(S,"\\longleftrightarrow ","&#8596;"),q.updownarrow=y(S,"\\updownarrow ","&#8597;"),q.Longleftrightarrow=y(S,"\\Longleftrightarrow ","&#8660;"),q.Updownarrow=y(S,"\\Updownarrow ","&#8661;"),q.mapsto=y(S,"\\mapsto ","&#8614;"),q.nearrow=y(S,"\\nearrow ","&#8599;"),q.hookleftarrow=y(S,"\\hookleftarrow ","&#8617;"),q.hookrightarrow=y(S,"\\hookrightarrow ","&#8618;"),q.searrow=y(S,"\\searrow ","&#8600;"),q.leftharpoonup=y(S,"\\leftharpoonup ","&#8636;"),q.rightharpoonup=y(S,"\\rightharpoonup ","&#8640;"),q.swarrow=y(S,"\\swarrow ","&#8601;"),q.leftharpoondown=y(S,"\\leftharpoondown ","&#8637;"),q.rightharpoondown=y(S,"\\rightharpoondown ","&#8641;"),q.nwarrow=y(S,"\\nwarrow ","&#8598;"),q.ldots=y(S,"\\ldots ","&#8230;"),q.cdots=y(S,"\\cdots ","&#8943;"),q.vdots=y(S,"\\vdots ","&#8942;"),q.ddots=y(S,"\\ddots ","&#8944;"),q.surd=y(S,"\\surd ","&#8730;"),q.triangle=y(S,"\\triangle ","&#9653;"),q.ell=y(S,"\\ell ","&#8467;"),q.top=y(S,"\\top ","&#8868;"),q.flat=y(S,"\\flat ","&#9837;"),q.natural=y(S,"\\natural ","&#9838;"),q.sharp=y(S,"\\sharp ","&#9839;"),q.wp=y(S,"\\wp ","&#8472;"),q.bot=y(S,"\\bot ","&#8869;"),q.clubsuit=y(S,"\\clubsuit ","&#9827;"),q.diamondsuit=y(S,"\\diamondsuit ","&#9826;"),q.heartsuit=y(S,"\\heartsuit ","&#9825;"),q.spadesuit=y(S,"\\spadesuit ","&#9824;"),q.oint=y(S,"\\oint ","&#8750;"),q.bigcap=y(S,"\\bigcap ","&#8745;"),q.bigcup=y(S,"\\bigcup ","&#8746;"),q.bigsqcup=y(S,"\\bigsqcup ","&#8852;"),q.bigvee=y(S,"\\bigvee ","&#8744;"),q.bigwedge=y(S,"\\bigwedge ","&#8743;"),q.bigodot=y(S,"\\bigodot ","&#8857;"),q.bigotimes=y(S,"\\bigotimes ","&#8855;"),q.bigoplus=y(S,"\\bigoplus ","&#8853;"),q.biguplus=y(S,"\\biguplus ","&#8846;"),q.lfloor=y(S,"\\lfloor ","&#8970;"),q.rfloor=y(S,"\\rfloor ","&#8971;"),q.lceil=y(S,"\\lceil ","&#8968;"),q.rceil=y(S,"\\rceil ","&#8969;"),q.slash=y(S,"\\slash ","&#47;"),q.opencurlybrace=y(S,"\\opencurlybrace ","&#123;"),q.closecurlybrace=y(S,"\\closecurlybrace ","&#125;"),q.caret=y(S,"\\caret ","^"),q.underscore=y(S,"\\underscore ","_"),q.backslash=y(S,"\\backslash ","\\"),q.vert=y(S,"|"),q.perp=q.perpendicular=y(S,"\\perp ","&perp;"),q.nabla=q.del=y(S,"\\nabla ","&nabla;"),q.hbar=y(S,"\\hbar ","&#8463;"),q.AA=q.Angstrom=q.angstrom=y(S,"\\text\\AA ","&#8491;"),q.ring=q.circ=q.circle=y(S,"\\circ ","&#8728;"),q.bull=q.bullet=y(S,"\\bullet ","&bull;"),q.setminus=q.smallsetminus=y(S,"\\setminus ","&#8726;"),q.not=q.neg=y(S,"\\neg ","&not;"),q.dots=q.ellip=q.hellip=q.ellipsis=q.hellipsis=y(S,"\\dots ","&hellip;"),q.converges=q.darr=q.dnarr=q.dnarrow=q.downarrow=y(S,"\\downarrow ","&darr;"),q.dArr=q.dnArr=q.dnArrow=q.Downarrow=y(S,"\\Downarrow ","&dArr;"),q.diverges=q.uarr=q.uparrow=y(S,"\\uparrow ","&uarr;"),q.uArr=q.Uparrow=y(S,"\\Uparrow ","&uArr;"),q.to=y(U,"\\to ","&rarr;"),q.rarr=q.rightarrow=y(S,"\\rightarrow ","&rarr;"),q.implies=y(U,"\\Rightarrow ","&rArr;"),q.rArr=q.Rightarrow=y(S,"\\Rightarrow ","&rArr;"),q.gets=y(U,"\\gets ","&larr;"),q.larr=q.leftarrow=y(S
,"\\leftarrow ","&larr;"),q.impliedby=y(U,"\\Leftarrow ","&lArr;"),q.lArr=q.Leftarrow=y(S,"\\Leftarrow ","&lArr;"),q.harr=q.lrarr=q.leftrightarrow=y(S,"\\leftrightarrow ","&harr;"),q.iff=y(U,"\\Leftrightarrow ","&hArr;"),q.hArr=q.lrArr=q.Leftrightarrow=y(S,"\\Leftrightarrow ","&hArr;"),q.Re=q.Real=q.real=y(S,"\\Re ","&real;"),q.Im=q.imag=q.image=q.imagin=q.imaginary=q.Imaginary=y(S,"\\Im ","&image;"),q.part=q.partial=y(S,"\\partial ","&part;"),q.inf=q.infin=q.infty=q.infinity=y(S,"\\infty ","&infin;"),q.alef=q.alefsym=q.aleph=q.alephsym=y(S,"\\aleph ","&alefsym;"),q.xist=q.xists=q.exist=q.exists=y(S,"\\exists ","&exist;"),q.and=q.land=q.wedge=y(S,"\\wedge ","&and;"),q.or=q.lor=q.vee=y(S,"\\vee ","&or;"),q.o=q.O=q.empty=q.emptyset=q.oslash=q.Oslash=q.nothing=q.varnothing=y(U,"\\varnothing ","&empty;"),q.cup=q.union=y(S,"\\cup ","&cup;"),q.cap=q.intersect=q.intersection=y(S,"\\cap ","&cap;"),q.deg=q.degree=y(S,"^\\circ ","&deg;"),q.ang=q.angle=y(S,"\\angle ","&ang;"),c=X.prototype=new i,c.respace=function(){this.jQ[0].className=this.next instanceof A||this.next instanceof F?"":"non-italicized-function"},q.ln=q.lg=q.log=q.span=q.proj=q.det=q.dim=q.min=q.max=q.mod=q.lcm=q.gcd=q.gcf=q.hcf=q.lim=X,function(){var a=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(var b in a)q[a[b]]=q[a[b]+"h"]=q["a"+a[b]]=q["arc"+a[b]]=q["a"+a[b]+"h"]=q["arc"+a[b]+"h"]=X}(),c=Y.prototype,c.prev=0,c.next=0,c.parent=0,c.show=function(){return this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this.next?this.selection&&this.selection.prev===this.prev?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this.next.jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this},c.hide=function(){return"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=a(),this},c.redraw=function(){for(var a=this.parent;a;a=a.parent)a.redraw&&a.redraw()},c.insertAt=function(a,b,c){var d=this.parent;this.parent=a,this.prev=b,this.next=c,d.blur()},c.insertBefore=function(a){return this.insertAt(a.parent,a.prev,a),this.parent.jQ.addClass("hasCursor"),this.jQ.insertBefore(a.jQ.first()),this},c.insertAfter=function(a){return this.insertAt(a.parent,a,a.next),this.parent.jQ.addClass("hasCursor"),this.jQ.insertAfter(a.jQ.last()),this},c.prependTo=function(a){return this.insertAt(a,0,a.firstChild),a.textarea?this.jQ.insertAfter(a.textarea):this.jQ.prependTo(a.jQ),a.focus(),this},c.appendTo=function(a){return this.insertAt(a,a.lastChild,0),this.jQ.appendTo(a.jQ),a.focus(),this},c.hopLeft=function(){return this.jQ.insertBefore(this.prev.jQ.first()),this.next=this.prev,this.prev=this.prev.prev,this},c.hopRight=function(){return this.jQ.insertAfter(this.next.jQ.last()),this.prev=this.next,this.next=this.next.next,this},c.moveLeft=function(){return this.selection?this.insertBefore(this.selection.prev.next||this.parent.firstChild).clearSelection():this.prev?this.prev.lastChild?this.appendTo(this.prev.lastChild):this.hopLeft():this.parent.prev?this.appendTo(this.parent.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent),this.show()},c.moveRight=function(){return this.selection?this.insertAfter(this.selection.next.prev||this.parent.lastChild).clearSelection():this.next?this.next.firstChild?this.prependTo(this.next.firstChild):this.hopRight():this.parent.next?this.prependTo(this.parent.next):this.parent!==this.root&&this.insertAfter(this.parent.parent),this.show()},c.seek=function(a,b,c){var e=this.clearSelection();if(a.hasClass("empty"))return e.prependTo(a.data(d).block),e;var f=a.data(d);if(f){if(f.cmd&&!f.block)return a.outerWidth()>2*(b-a.offset().left)?e.insertBefore(f.cmd):e.insertAfter(f.cmd),e}else a=a.parent(),f=a.data(d),f||(f={block:e.root});f.cmd?e.insertAfter(f.cmd):e.appendTo(f.block);var g=e.jQ.offset().left-b,h;do e.moveLeft(),h=g,g=e.jQ.offset().left-b;while(g>0&&(e.prev||e.parent!==e.root));return-g>h&&e.moveRight(),e},c.writeLatex=function(a){return this.deleteSelection(),a=a&&a.match(/\\text\{([^}]|\\\})*\}|\\[a-z]*|[^\s]/ig)||0,function c(d){while(a.length){var e=a.shift();if(!e||e==="}")return;var f;if(e.slice(0,6)==="\\text{"){f=new K(e.slice(6,-1)),d.insertNew(f).insertAfter(f);continue}if(e==="\\left"||e==="\\right"){e=a.shift(),e==="\\"&&(e=a.shift()),d.insertCh(e),f=d.prev||d.parent.parent;if(d.prev)return;a.unshift("{")}else if(/^\\[a-z]+$/i.test(e)){e=e.slice(1);var f=q[e];if(f)d.insertNew(f=new f(b,e));else{f=new K(e),d.insertNew(f).insertAfter(f);continue}}else e.match(/[a-eg-zA-Z]/)?f=new R(e):(f=q[e])?f=new f:f=new S(e),d.insertNew(f);f.eachChild(function(b){d.appendTo(b);var e=a.shift();if(!e)return!1;e==="{"?c(d):d.insertCh(e)}),d.insertAfter(f)}}(this),this.hide()},c.write=function(a){return this.show().insertCh(a)},c.insertCh=function(a){this.selection&&(this.prev=this.selection.prev,this.next=this.selection.next);var b;return a.match(/^[a-eg-zA-Z]$/)?b=new R(a):(b=p[a]||q[a])?b=new b(this.selection,a):b=new S(a),this.selection&&(b instanceof i&&this.selection.remove(),delete this.selection),this.insertNew(b)},c.insertNew=function(a){return a.insertAt(this),this},c.unwrapGramp=function(){var a=this.parent.parent,b=a.parent,c=a.prev,d=this;a.eachChild(function(d){if(d.isEmpty())return;d.eachChild(function(c){c.parent=b,c.jQ.insertBefore(a.jQ.first())}),d.firstChild.prev=c,c?c.next=d.firstChild:b.firstChild=d.firstChild,c=d.lastChild}),c.next=a.next,a.next?a.next.prev=c:b.lastChild=c;if(!this.next)if(this.prev)this.next=this.prev.next;else while(!this.next){this.parent=this.parent.next;if(this.parent)this.next=this.parent.firstChild;else{this.next=a.next,this.parent=b;break}}this.next?this.insertBefore(this.next):this.appendTo(b),a.jQ.remove(),a.prev&&a.prev.respace(),a.next&&a.next.respace()},c.backspace=function(){if(!this.deleteSelection())if(this.prev)this.prev.isEmpty()?this.prev=this.prev.remove().prev:this.selectLeft();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertAfter(this.parent.parent).backspace();this.unwrapGramp()}return this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw(),this},c.deleteForward=function(){if(!this.deleteSelection())if(this.next)this.next.isEmpty()?this.next=this.next.remove().next:this.selectRight();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertBefore(this.parent.parent).deleteForward();this.unwrapGramp()}return this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw(),this},c.selectFrom=function(a){var b=this,c=a;d:for(;;){for(var e=this;e!==b.parent.parent;e=e.parent.parent)if(e.parent===c.parent){g=e,h=c;break d}for(var f=a;f!==c.parent.parent;f=f.parent.parent)if(b.parent===f.parent){g=b,h=f;break d}b.parent.parent&&(b=b.parent.parent),c.parent.parent&&(c=c.parent.parent)}var g,h,i;if(g.next!==h){for(var j=g;j;j=j.next)if(j===h.prev){i=!0;break}i||(i=h,h=g,g=i)}this.hide().selection=new Z(g.parent,g.prev,h.next),this.insertAfter(h.next.prev||h.parent.lastChild),this.root.selectionChanged()},c.selectLeft=function(){if(this.selection)if(this.selection.prev===this.prev)this.prev?(this.hopLeft().next.jQ.prependTo(this.selection.jQ),this.selection.prev=this.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent).selection.levelUp();else{this.prev.jQ.insertAfter(this.selection.jQ),this.hopLeft().selection.next=this.next;if(this.selection.prev===this.prev){this.deleteSelection();return}}else{if(this.prev)this.hopLeft();else if(this.parent!==this.root)this.insertBefore(this.parent.parent);else return;this.hide().selection=new Z(this.parent,this.prev,this.next.next)}this.root.selectionChanged()},c.selectRight=function(){if(this.selection)if(this.selection.next===this.next)this.next?(this.hopRight().prev.jQ.appendTo(this.selection.jQ),this.selection.next=this.next):this.parent!==this.root&&this.insertAfter(this.parent.parent).selection.levelUp();else{this.next.jQ.insertBefore(this.selection.jQ),this.hopRight().selection.prev=this.prev;if(this.selection.next===this.next){this.deleteSelection();return}}else{if(this.next)this.hopRight();else if(this.parent!==this.root)this.insertAfter(this.parent.parent);else return;this.hide().selection=new Z(this.parent,this.prev.prev,this.next)}this.root.selectionChanged()},c.clearSelection=function(){return this.show().selection&&(this.selection.clear(),delete this.selection,this.root.selectionChanged()),this},c.deleteSelection=function(){return this.show().selection?(this.prev=this.selection.prev,this.next=this.selection.next,this.selection.remove(),delete this.selection,this.root.selectionChanged(),!0):!1},c=Z.prototype=new k,c.jQinit=function(a){this.jQ=a.wrapAll('<span class="selection"></span>').parent()},c.levelUp=function(){return this.clear().jQinit(this.parent.parent.jQ),this.prev=this.parent.parent.prev,this.next=this.parent.parent.next,this.parent=this.parent.parent.parent,this},c.clear=function(){return this.jQ.replaceWith(this.jQ.children()),this},c.blockify=function(){return this.jQ.replaceWith(this.jQ=this.jQ.children()),k.prototype.blockify.call(this)},c.detach=function(){var a=k.prototype.blockify.call(this);return this.blockify=function(){return this.jQ.replaceWith(a.jQ=this.jQ=this.jQ.children()),a},this},a.fn.mathquill=function(b,c){switch(b){case"redraw":return this.find(":not(:has(:first))").each(function(){var b=a(this).data(d);b&&(b.cmd||b.block)&&Y.prototype.redraw.call(b.cmd||b.block)}),this;case"revert":return this.each(function(){var b=a(this).data(d);b&&b.revert&&b.revert()});case"latex":if(arguments.length>1)return this.each(function(){var b=a(this).data(d);b&&b.block&&b.block.renderLatex&&b.block.renderLatex(c)});var e=this.data(d);return e&&e.block&&e.block.latex();case"text":var e=this.data(d);return e&&e.block&&e.block.text();case"html":return this.html().replace(/ ?hasCursor|hasCursor /,"").replace(/ class=(""|(?= |>))/g,"").replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var b=a(this).data(d),e=b&&b.block,f=e&&e.cursor;f&&(f.writeLatex(c),e.blur())});default:var f=b==="textbox",g=f||b==="editable",h=f?o:m;return this.each(function(){l(a(this),new h,f,g)})}},a(function(){a(".mathquill-editable:not(.mathquill-rendered-math)").mathquill("editable"),a(".mathquill-textbox:not(.mathquill-rendered-math)").mathquill("textbox"),a(".mathquill-embedded-latex").mathquill()})})()